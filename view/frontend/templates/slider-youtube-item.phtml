<?php

declare(strict_types=1);

use Magento\Framework\View\Element\Template;
use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\HyvaCsp;
use Magento\Framework\App\ObjectManager;

/** @var Template $block */
/** @var ViewModelRegistry $viewModels */
/** @var HyvaCsp $hyvaCsp */

// Fallback for viewModels if not available in block context
if (!isset($viewModels)) {
    $viewModels = ObjectManager::getInstance()->get(ViewModelRegistry::class);
}

$hyvaCsp = $viewModels->require(HyvaCsp::class);

$item = $block->getItem() ?? [];
$divId = $item['divId'] ?? uniqid('video_');
$videoId = $item['videoId'] ?? '';

if (empty($videoId)) {
    return;
}

?>
<script>
    if (typeof gardenLawnYoutubePlayer === 'undefined') {
        window.gardenLawnYoutubePlayer = function (divId, videoId) {
            return {
                divId: divId,
                videoId: videoId,
                player: null,
                loadPlayer() {
                    // console.log('GardenLawn: loadPlayer called for', this.divId);
                    if (this.player || !this.videoId) return;

                    const create = () => {
                        // console.log('GardenLawn: Creating player for', this.divId);
                        try {
                            this.player = new YT.Player(this.divId, {
                                height: '100%',
                                width: '100%',
                                videoId: this.videoId,
                                host: 'https://www.youtube.com',
                                playerVars: {
                                    'playsinline': 1,
                                    'rel': 0,
                                    'modestbranding': 1,
                                    'origin': window.location.origin
                                },
                                events: {
                                    'onError': (e) => console.error('GardenLawn Player Error:', e)
                                }
                            });
                        } catch (e) {
                            console.error('GardenLawn Youtube Error:', e);
                        }
                    };

                    if (typeof YT !== 'undefined' && typeof YT.Player !== 'undefined') {
                        create();
                    } else {
                        if (!document.querySelector('script[src*="youtube.com/iframe_api"]')) {
                            const tag = document.createElement('script');
                            tag.src = "https://www.youtube.com/iframe_api";
                            document.head.appendChild(tag);
                        }

                        const check = setInterval(() => {
                            if (typeof YT !== 'undefined' && typeof YT.Player !== 'undefined') {
                                clearInterval(check);
                                create();
                            }
                        }, 100);
                    }
                }
            }
        }
    }
</script>

<div class="slider-item w-full px-2" x-data="gardenLawnYoutubePlayer('<?= $block->escapeJs($divId) ?>', '<?= $block->escapeJs($videoId) ?>')">
    <div id="<?= $block->escapeHtmlAttr($divId) ?>" class="w-full aspect-video bg-gray-200" x-init="loadPlayer"></div>
</div>
<?php $hyvaCsp->registerInlineScript() ?>
