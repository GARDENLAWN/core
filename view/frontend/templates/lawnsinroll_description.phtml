<?php declare(strict_types=1);

/** @var Template $block */
/** @var Escaper $escaper */
/** @var ViewModelRegistry $viewModels */

/** @var Slider $sliderViewModel */

use Hyva\Theme\Model\ViewModelRegistry;
use Hyva\Theme\ViewModel\Slider;
use Magento\Catalog\Block\Product\View;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;

/** @var View $block */
$product = $block->getProduct();
$sliderViewModel = $viewModels->require(Slider::class);

// Helper to render and clean external templates using Shadow DOM for isolation
$renderGrassInfo = function($templateName) use ($block) {
    $fileName = $block->getTemplateFile('GardenLawn_Core::' . $templateName);
    if (!file_exists($fileName)) {
        return '';
    }
    ob_start();
    include $fileName;
    $content = ob_get_clean();

    // Extract html classes
    $htmlClasses = '';
    if (preg_match('/<html[^>]*class=["\']([^"\']*)["\']/', $content, $matches)) {
        $htmlClasses = $matches[1];
    }

    // Extract body classes
    $bodyClasses = '';
    if (preg_match('/<body[^>]*class=["\']([^"\']*)["\']/', $content, $matches)) {
        $bodyClasses = $matches[1];
    }

    // Remove Doctype and html/head/body tags wrapper
    $content = preg_replace('/<!DOCTYPE html>/i', '', $content);
    $content = preg_replace('/<html[^>]*>/i', '', $content);
    $content = preg_replace('/<\/html>/i', '', $content);
    $content = preg_replace('/<head>/i', '', $content);
    $content = preg_replace('/<\/head>/i', '', $content);
    $content = preg_replace('/<body[^>]*>/i', '', $content);
    $content = preg_replace('/<\/body>/i', '', $content);

    // Remove title, meta, canonical, json-ld
    $content = preg_replace('/<title>.*?<\/title>/is', '', $content);
    $content = preg_replace('/<meta[^>]*>/i', '', $content);
    $content = preg_replace('/<link rel="canonical"[^>]*>/i', '', $content);
    $content = preg_replace('/<script type="application\/ld\+json".*?<\/script>/is', '', $content);

    // Remove jQuery to avoid duplicates/errors
    $content = preg_replace('/<script[^>]*jquery\.min\.js[^>]*><\/script>/i', '', $content);
    $content = preg_replace('/<script[^>]*jquery-migrate\.min\.js[^>]*><\/script>/i', '', $content);

    // Remove body overflow styles
    $content = preg_replace('/body\s*{[^}]*overflow:[^}]*}/is', '', $content);

    // Replace 'body' selector in CSS with .body-wrapper
    $content = preg_replace('/(?<=})\s*body\s*{/', '.body-wrapper {', $content);
    $content = preg_replace('/^\s*body\s*{/', '.body-wrapper {', $content);

    // Inject responsive styles and reset for Shadow DOM
    $responsiveStyles = '<style>
        :host { display: block; all: initial; contain: content; }
        .body-wrapper {
            width: 100%;
            overflow-x: hidden;
            background-color: #fff;
            font-family: "Open Sans", sans-serif;
            color: #111;
        }
        .body-wrapper * {
            max-width: 100% !important;
            box-sizing: border-box !important;
        }
        .body-wrapper img {
            height: auto !important;
        }
        /* Hide header/footer elements if they exist in the content */
        header, footer, .u-header { display: none !important; }
    </style>';

    // Wrap in Declarative Shadow DOM
    return '<div class="grass-info-host ' . $htmlClasses . '">' .
           '<template shadowrootmode="open">' .
           $responsiveStyles .
           '<div class="body-wrapper ' . $bodyClasses . '">' . $content . '</div>' .
           '</template>' .
           '</div>';
};

?>
<style type="text/css">
    .topnav a {
        text-align: center;
    }

    .tabs-container {
        padding: 0;
        margin-left: -23px;
    }

    .tabs-navigation {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
    }

    @media (max-width: 768px) {
        .tabs-container {
            margin-left: 0;
            width: 100%;
        }
        .tabs-navigation li {
            flex: 1 1 auto; /* Allow tabs to shrink/grow */
        }
        .tabs-navigation a {
            padding: 10px 5px; /* Reduce padding on mobile */
            font-size: 14px;
        }
    }
</style>

<!-- Polyfill for Declarative Shadow DOM (for older browsers) -->
<script>
    (function() {
        if (HTMLTemplateElement.prototype.hasOwnProperty('shadowRootMode')) return;
        document.querySelectorAll('template[shadowrootmode]').forEach(t => {
            const mode = t.getAttribute('shadowrootmode');
            const shadowRoot = t.parentNode.attachShadow({ mode });
            shadowRoot.appendChild(t.content);
            t.remove();
        });
    })();
</script>

<section>
    <?= $block->getChildHtml('product_options_wrapper_bottom') ?>
</section>


<div id="tabs-description">
    <div class="tabs-container" data-content-type="tabs" data-appearance="default" data-active-tab=""
         data-element="main">
        <ul role="tablist" style="text-align: center;" class="tabs-navigation" data-element="navigation">
            <li role="tab" class="tab-header active" data-element="headers"><a href="#tab_1" class="tab-title"><span
                        class="tab-title">Trawa z Rolki</span></a></li>
            <li role="tab" class="tab-header" data-element="headers"><a href="#tab_2" class="tab-title"><span
                        class="tab-title">O Producencie</span></a></li>
            <li role="tab" class="tab-header" data-element="headers"><a href="#tab_3" class="tab-title"><span
                        class="tab-title">Pielęgnacja Trawnika</span></a></li>
            <li role="tab" class="tab-header" data-element="headers"><a href="#tab_4" class="tab-title"><span
                        class="tab-title">Zakładanie Trawnika</span></a></li>
            <li role="tab" class="tab-header" data-element="headers"><a href="#tab_5" class="tab-title"><span
                        class="tab-title">Logistyka</span></a></li>
        </ul>
        <div id="tab-content" class="tabs-content" data-element="content" style="width: 100%;">
            <div data-content-type="tab-item" data-appearance="default" data-tab-name="Trawa z Rolki"
                 data-background-images="{}"
                 data-element="main" id="tab_1" style="padding: 0">
                <?= $renderGrassInfo('grassinfo1.phtml') ?>
            </div>
            <div data-content-type="tab-item" data-appearance="default" data-tab-name="O Producencie"
                 data-background-images="{}"
                 data-element="main" id="tab_2" style="padding: 0; display: none;">
                <?= $renderGrassInfo('grassinfo2.phtml') ?>
            </div>
            <div data-content-type="tab-item" data-appearance="default" data-tab-name="Pielęgnacja Trawnika"
                 data-background-images="{}"
                 data-element="main" id="tab_3" style="padding: 0; display: none;">
                <?= $renderGrassInfo('grassinfo3.phtml') ?>
            </div>
            <div data-content-type="tab-item" data-appearance="default" data-tab-name="Zakładanie Trawnika"
                 data-background-images="{}"
                 data-element="main" id="tab_4" style="padding: 0; display: none;">
                <?= $renderGrassInfo('grassinfo4.phtml') ?>
            </div>
            <div data-content-type="tab-item" data-appearance="default" data-tab-name="Logistyka"
                 data-background-images="{}"
                 data-element="main" id="tab_5" style="padding: 0; display: none;">
                <?= $renderGrassInfo('grassinfo5.phtml') ?>
            </div>
        </div>
    </div>
</div>

<script>
    document.querySelectorAll('.tabs-navigation a').forEach(tab => {
        tab.addEventListener('click', function(e) {
            e.preventDefault();

            // Remove active class from all headers
            document.querySelectorAll('.tabs-navigation .tab-header').forEach(h => h.classList.remove('active'));
            // Add active class to clicked header parent
            this.parentElement.classList.add('active');

            // Hide all tab contents
            document.querySelectorAll('.tabs-content > div').forEach(c => c.style.display = 'none');

            // Show target tab content
            const targetId = this.getAttribute('href').substring(1);
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
        });
    });
</script>
